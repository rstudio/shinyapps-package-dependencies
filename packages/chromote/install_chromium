#!/bin/bash

set -x
set -e

apt-get update -qq

# On Ubuntu <= 18...
if [ ${OS_CODENAME} == "xenial" ]; then
  apt-get install -y chromium-browser
else
  ## On Ubuntu Focal...
  ## When installing chromium using ...
  # apt-get install -y chromium-browser
  ## When `chromium` is first ran, an error will be throw, asking you to install chromium using...
  # snap install chromium
  ## However, installing `snapd` on docker is not trivial. :-(


  # Following directions similar to
  # * Chromium official suggestion: https://github.com/scheib/chromium-latest-linux/blob/4f4e9b85ea02a109e071452de936389cc2fd7376/update.sh
  # * GHA Virtual Environments: https://github.com/actions/virtual-environments/blob/cfffe35709dcc45d09f0a08189be5984f3f13bbb/images/linux/scripts/installers/google-chrome.sh#L69-L85

  # Install all dependencies that are not regularly installed when using `.deb` files
  # https://github.com/puppeteer/puppeteer/blob/feec588f951d8833e3b9758cde9f34c325837407/.ci/node12/Dockerfile.linux#L3-L9
  # Matches libraries installed when using xenial deb file
  apt-get install -y xvfb gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 \
    libdbus-1-3 libexpat1 libfontconfig1 libgbm1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 \
    libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 \
    libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 \
    libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget

  # Set up variables
  CHROMIUM_VERSION_FILE="chromiumLastChange.txt"
  CHROMIUM_ZIP_FILE="chromium.zip"
  CHROMIUM_ZIP_FOLDER="/tmp/chromium"
  CHROMIUM_ZIP="${CHROMIUM_ZIP_FOLDER}/${CHROMIUM_ZIP_FILE}"

  mkdir -p "${CHROMIUM_ZIP_FOLDER}"

  # Download chromium latest version. Ex: 382086
  curl -L4 "https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Linux_x64%2FLAST_CHANGE?alt=media" -o "${CHROMIUM_VERSION_FILE}"
  CHROMIUM_VERSION=`cat ${CHROMIUM_VERSION_FILE}`
  curl -L4 "https://www.googleapis.com/download/storage/v1/b/chromium-browser-snapshots/o/Linux_x64%2F${CHROMIUM_VERSION}%2Fchrome-linux.zip?alt=media" -o "${CHROMIUM_ZIP}"


  # Unzip Chromium archive
  CHROMIUM_FOLDER="/usr/local/share/chromium"
  CHROMIUM_BIN="$CHROMIUM_FOLDER/chrome-linux/chrome"

  mkdir "${CHROMIUM_FOLDER}"
  unzip -qq ${CHROMIUM_ZIP} -d "${CHROMIUM_FOLDER}"

  # Link binaries
  ln -s "${CHROMIUM_BIN}" /usr/bin/chromium
  ln -s "${CHROMIUM_BIN}" /usr/bin/chromium-browser

fi
